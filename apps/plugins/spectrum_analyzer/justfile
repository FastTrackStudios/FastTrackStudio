# Justfile for Spectrum Analyser Plugin
# Usage: just <command> [args...]

# Configuration
PLUGIN_NAME := "spectrum_analyser"
CLAP_DIR := "/Library/Audio/Plug-Ins/CLAP"
PLUGIN_CLAP := PLUGIN_NAME + ".clap"
LOG_FILE := env_var("HOME") / "Library/Logs/REAPER/nih.log"
REAPER_EXECUTABLE := "/Users/codywright/Music/FTS-REAPER/FTS-LIVE.app/Contents/MacOS/REAPER"
REAPER_RESOURCES := "/Users/codywright/Music/FTS-REAPER/FTS-LIVE.app/Contents/Resources"

# Default recipe - show help
default: help

# ============================================================================
# Build Commands
# ============================================================================

# Build the plugin in release mode
build:
    cargo xtask bundle {{PLUGIN_NAME}} --release

# Build the plugin in debug mode
build-debug:
    cargo xtask bundle {{PLUGIN_NAME}}

# Build with WGPU debug logging enabled
build-wgpu-debug:
    RUST_LOG=wgpu_core=debug,wgpu_hal=debug cargo xtask bundle {{PLUGIN_NAME}} --release

# ============================================================================
# Install Commands
# ============================================================================

# Install plugin to system CLAP directory (requires sudo)
install: build
    #!/usr/bin/env bash
    set -euo pipefail
    echo "üóëÔ∏è  Removing old plugin if it exists..."
    if [ -d "{{CLAP_DIR}}/{{PLUGIN_CLAP}}" ]; then
        sudo rm -rf "{{CLAP_DIR}}/{{PLUGIN_CLAP}}"
        echo "‚úÖ Old plugin removed"
    else
        echo "‚ÑπÔ∏è  No existing plugin found"
    fi
    echo "üì¶ Installing new plugin..."
    sudo cp -r "./target/bundled/{{PLUGIN_CLAP}}" "{{CLAP_DIR}}/"
    echo "üéâ Plugin installed to: {{CLAP_DIR}}/{{PLUGIN_CLAP}}"

# Uninstall plugin from system CLAP directory
uninstall:
    #!/usr/bin/env bash
    set -euo pipefail
    if [ -d "{{CLAP_DIR}}/{{PLUGIN_CLAP}}" ]; then
        sudo rm -rf "{{CLAP_DIR}}/{{PLUGIN_CLAP}}"
        echo "üóëÔ∏è  Plugin removed from: {{CLAP_DIR}}/{{PLUGIN_CLAP}}"
    else
        echo "‚ÑπÔ∏è  No plugin found at: {{CLAP_DIR}}/{{PLUGIN_CLAP}}"
    fi

# ============================================================================
# REAPER Commands
# ============================================================================

# Launch FTS REAPER with NIH logging enabled
reaper:
    #!/usr/bin/env bash
    set -euo pipefail
    mkdir -p "$(dirname "{{LOG_FILE}}")"
    echo "üöÄ Launching FTS REAPER..."
    echo "üìã Logs: {{LOG_FILE}}"
    cd "{{REAPER_RESOURCES}}"
    NIH_LOG="{{LOG_FILE}}" "{{REAPER_EXECUTABLE}}"

# Launch REAPER with WGPU debug logging
reaper-debug:
    #!/usr/bin/env bash
    set -euo pipefail
    mkdir -p "$(dirname "{{LOG_FILE}}")"
    echo "üöÄ Launching FTS REAPER (debug mode)..."
    echo "üìã Logs: {{LOG_FILE}}"
    cd "{{REAPER_RESOURCES}}"
    MTL_HUD_ENABLED=1 RUST_LOG=wgpu_core=debug,wgpu_hal=debug NIH_LOG="{{LOG_FILE}}" "{{REAPER_EXECUTABLE}}"

# ============================================================================
# Development Workflows
# ============================================================================

# Build, install, and launch REAPER (full dev cycle)
run: install reaper

# Build, install, and launch REAPER with debug logging
run-debug: install reaper-debug

# Build, install, and open tmux session with REAPER + log monitoring
dev: install
    #!/usr/bin/env bash
    set -euo pipefail
    mkdir -p "$(dirname "{{LOG_FILE}}")"
    
    echo "üì∫ Starting development panes..."
    
    # Split current pane horizontally, run REAPER in new pane on right
    tmux split-window -h "cd \"{{REAPER_RESOURCES}}\" && NIH_LOG=\"{{LOG_FILE}}\" \"{{REAPER_EXECUTABLE}}\""
    
    # Current pane (left) will show logs
    echo "üéØ REAPER launched in right pane"
    echo "   Use Ctrl+B then arrow keys to switch panes"
    echo "   Showing logs below..."
    echo ""
    
    # Tail logs in current pane
    while [ ! -f "{{LOG_FILE}}" ]; do sleep 1; done
    tail -f "{{LOG_FILE}}"

# Watch logs (tail the NIH log file)
logs:
    #!/usr/bin/env bash
    if [ -f "{{LOG_FILE}}" ]; then
        tail -f "{{LOG_FILE}}"
    else
        echo "‚è≥ Waiting for log file: {{LOG_FILE}}"
        while [ ! -f "{{LOG_FILE}}" ]; do sleep 1; done
        tail -f "{{LOG_FILE}}"
    fi

# Clear log file
clear-logs:
    #!/usr/bin/env bash
    if [ -f "{{LOG_FILE}}" ]; then
        rm "{{LOG_FILE}}"
        echo "üóëÔ∏è  Cleared: {{LOG_FILE}}"
    else
        echo "‚ÑπÔ∏è  No log file to clear"
    fi

# ============================================================================
# Utility Commands
# ============================================================================

# Check code without building
check:
    cargo check

# Run clippy lints
lint:
    cargo clippy

# Format code
fmt:
    cargo fmt

# Clean build artifacts
clean:
    cargo clean

# Show plugin info and paths
info:
    #!/usr/bin/env bash
    echo "Plugin Information"
    echo "=================="
    echo "Name:           {{PLUGIN_NAME}}"
    echo "CLAP Directory: {{CLAP_DIR}}"
    echo "Log File:       {{LOG_FILE}}"
    echo "REAPER:         {{REAPER_EXECUTABLE}}"
    echo ""
    echo "Installed Plugin:"
    if [ -d "{{CLAP_DIR}}/{{PLUGIN_CLAP}}" ]; then
        ls -la "{{CLAP_DIR}}/{{PLUGIN_CLAP}}"
    else
        echo "  (not installed)"
    fi

# Show help
help:
    #!/usr/bin/env bash
    echo "Spectrum Analyser Plugin - Development Commands"
    echo ""
    echo "Build:"
    echo "  just build           Build plugin (release)"
    echo "  just build-debug     Build plugin (debug)"
    echo "  just install         Build and install to CLAP directory"
    echo "  just uninstall       Remove plugin from CLAP directory"
    echo ""
    echo "Development:"
    echo "  just run             Build, install, and launch REAPER"
    echo "  just run-debug       Same as run, with WGPU debug logging"
    echo "  just dev             Build, install, launch REAPER in tmux with log monitoring"
    echo ""
    echo "REAPER:"
    echo "  just reaper          Launch FTS REAPER with NIH logging"
    echo "  just reaper-debug    Launch with WGPU debug logging"
    echo ""
    echo "Logs:"
    echo "  just logs            Tail the NIH log file"
    echo "  just clear-logs      Clear the log file"
    echo ""
    echo "Utility:"
    echo "  just check           Check code without building"
    echo "  just lint            Run clippy"
    echo "  just fmt             Format code"
    echo "  just clean           Clean build artifacts"
    echo "  just info            Show plugin info and paths"
